<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>155-maktab Axborot Paneli</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    html, body { height:100%; overflow:hidden; }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(135deg,#3ac8ff 0%, #9be7d9 50%, #ffde7b 100%);
      color:#033047;
    }

    .container {
      width:95vw; height:95vh;
      border-radius:24px;
      background: rgba(255,255,255,0.08);
      box-shadow: 0 8px 30px rgba(0,0,0,0.25);
      position:relative;
      padding:32px;
      display:flex;
      flex-direction:column;
      align-items:center;
      overflow:hidden;
    }

    .school-name {
      font-size:70px;
      font-weight:900;
      margin:6px 0 16px;
      text-shadow: 0 6px 20px rgba(0,0,0,0.25);
      color:#fff;
    }

    .datetime {
      position:absolute;
      top:20px;
      right:30px;
      text-align:right;
      font-size:22px;
      line-height:1.4;
      font-weight:600;
      color:#fff;
      display:flex;
      flex-direction:column-reverse;
      align-items:flex-end;
    }

    .slide {
      width:95%;
      height:80%;
      border-radius:22px;
      background: rgba(255,255,255,0.55);
      padding:60px 35px 35px 35px;
      margin-top:12px;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      align-items:center;
      text-align:center;
      overflow:auto;
      font-size:20px;
      color:#012a33;
      box-shadow: 0 0 40px rgba(255,255,255,0.2);
      transition: opacity .45s ease;
    }

    .slide.fade-out { opacity:0; }

    .slide h2 {
      margin-top:0;
      margin-bottom:25px;
      font-size:32px;
    }

    .menu-btn {
      position:absolute;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      z-index:1100;
      background:#ffbb00;
      color:#000;
      border:none;
      padding:20px 50px;
      border-radius:32px;
      font-size:20px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,0.25);
      transition: all .3s ease;
    }

    .menu-btn:hover { transform:translateX(-50%) scale(1.05); }

    .menu-overlay {
      position:absolute;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(8px);
      opacity:0;
      pointer-events:none;
      transition: opacity .35s ease;
      z-index:900;
    }

    .menu-overlay.active { opacity:1; pointer-events:auto; }

    .menu-panel {
      position:absolute;
      top:100%;
      left:0;
      width:100%;
      height:100%;
      padding:20px 40px;
      display:flex;
      gap:20px;
      justify-content:center;
      align-items:flex-start;
      overflow-y:auto;
      transition: top .45s ease;
      z-index:1000;
      background: rgba(255,255,255,0.95);
    }

    .menu-panel.open { top:0; }

    .menu-panel * { font-size:14px; }

    /* ===== –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ö–ê–†–¢–û–ß–ï–ö –ö–û–ú–ù–ê–¢ ===== */
    .floor-light {
      min-width:280px;
      border-radius:14px;
      padding:12px;
      background:linear-gradient(135deg,rgba(255,255,255,0.95),rgba(245,245,245,0.9));
      box-shadow:0 0 15px rgba(0,0,0,0.06);
      font-size:13px;
      color:#012a33;
    }

    .floor-light h3 { 
      margin:0 0 8px; 
      font-size:15px; 
      font-weight:700; 
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* –û–±—ã—á–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –∫–æ–º–Ω–∞—Ç—ã */
    .room-light {
      padding:12px;
      margin:8px 0;
      border-radius:10px;
      font-size:13px;
      background:#fff;
      color:#012a33;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      display: flex;
      gap: 12px;
      align-items: flex-start;
      text-align: left;
      transition: all 0.2s ease;
    }

    /* –ü–æ–¥—Å–≤–µ—á–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –∫–æ–º–Ω–∞—Ç—ã */
    .room-light.highlight {
      background: linear-gradient(90deg, #fff4d6, #fff1c4);
      border-left: 4px solid #ffbb00;
      box-shadow: 0 4px 12px rgba(255, 187, 0, 0.15);
    }

    .room-icon {
      font-size: 18px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: rgba(0,0,0,0.03);
      flex-shrink: 0;
    }

    .room-light.highlight .room-icon {
      background: rgba(255, 187, 0, 0.12);
    }

    .room-info { 
      flex: 1;
    }

    .room-name { 
      font-weight: 800; 
      font-size: 15px; 
      margin-bottom: 4px;
      display: block;
    }

    .class-name { 
      color: #345; 
      font-weight: 600; 
      margin-bottom: 4px;
    }

    .teacher { 
      color: #567; 
      font-size: 12px; 
      margin-bottom: 2px;
    }

    .desc { 
      color: #789; 
      font-size: 11px; 
      opacity: 0.9;
    }

    /* --- photo slider --- */
    .slider-container {
      position: relative;
      width: 100%;
      min-height: 240px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin-top: 12px;
      overflow: hidden;
    }

    .slider-images { position: relative; width:100%; display:flex; justify-content:center; align-items:center; min-height:180px; }
    .slider-img {
      max-width: 100%;
      max-height: 420px;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 14px;
      position: absolute;
      opacity: 0;
      transition: opacity 0.7s ease;
      box-shadow: 0 6px 30px rgba(0,0,0,0.12);
    }
    .slider-img.active { opacity: 1; position: relative; }

    .slider-dots {
      display: flex;
      justify-content: center;
      margin-top: 12px;
      gap: 8px;
    }
    .dot {
      width:11px; height:11px; border-radius:50%;
      background: rgba(0,0,0,0.12);
      transition: all .25s ease; cursor:pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .dot.active-dot {
      background: #ffb700;
      transform: scale(1.25);
      box-shadow: 0 6px 18px rgba(255,183,0,0.35);
    }

    /* --- main slide dots --- */
    .main-dots {
      position:absolute;
      bottom:94px;
      display:flex;
      gap:10px;
      z-index:1100;
    }
    .main-dot {
      width:14px; height:14px; border-radius:50%;
      background: rgba(255,255,255,0.45);
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
      cursor:pointer; transition: all .25s ease;
    }
    .main-dot.active { background:#ffbb00; transform:scale(1.25); }

    @media (max-width:900px){
      .school-name{ font-size:42px; }
      .slide{ height:75%; width:95%; font-size:16px; padding-top:40px; }
      .menu-btn{ padding:14px 28px; font-size:16px; }
      .datetime{ font-size:18px; }
      .menu-panel { padding:20px; flex-wrap:wrap; }
      .floor-light { min-width: 240px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="datetime" id="datetime"></div>
    <div class="school-name">155-maktab</div>
    <div class="slide" id="slide-content">Ma'lumot yuklanmoqda...</div>

    <div class="main-dots" id="main-dots"></div>

    <button class="menu-btn" id="menu-btn">Xonalar menyusi</button>

    <div class="menu-overlay" id="menu-overlay"></div>
    <div class="menu-panel" id="menu-panel"></div>
  </div>

  <script>
    /* ===== CONFIG ===== */
    const SHEET_ID = "1Z1wyUYj4l-D_egywsnPEiLU7CbXs7OFVN5qbAQ9ttzA";
    const API_KEY  = "AIzaSyApl7_bMpqpB9GXrxUtVAfaTfNtrhyEcgM";

    const SHEETS = {
      news: "News!A2:D100",
      students: "TopStudents!A2:C100",
      classes: "TopClass!A2:C100",
      rooms: "Rooms!A2:F200", // A:Floor, B:Room, C:Class, D:Teacher, E:Description, F:highlight
      quarter: "QuarterBestClasses!A2:D100"
    };

    /* ===== –î–û–ë–ê–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò ===== */
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å—Ç—Ä–æ–∫–∏
    function safeGet(row, idx){ 
      return (row && row[idx]) ? String(row[idx]).trim() : ""; 
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –∏–∫–æ–Ω–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞
    function chooseIcon(text){
      if(!text) return "üìç";
      text = String(text).toLowerCase();
      if(text.match(/rahbariyat/)) return "üëî";
      if(text.match(/informat|kompyut|ict|computer|kod/)) return "üíª";
      if(text.match(/matem|algebr|‚ûó|matemat/)) return "‚ûó";
      if(text.match(/bio|biolog|üß¨/)) return "üß¨";
      if(text.match(/kimy|kimyo|lab/)) return "üî¨";
      if(text.match(/fizik|fizika|‚öóÔ∏è|üèã/)) return "‚öôÔ∏è";
      if(text.match(/ona|til|tili|language|/)) return "üìö";
      if(text.match(/kitob|kutubxona|kutub/)) return "üìñ";
      if(text.match(/san'at|tasvir|rassom|art/)) return "üé®";
      if(text.match(/sport|stad|gym/)) return "üèÖ";
      if(text.match(/ma'naviyat|maonav|ma'nav/)) return "üïäÔ∏è";
      if(text.match(/ma'lumot|info|office/)) return "üè¢";
      if(text.match(/tibbiyot|tibbiy/)) return "üíä";
      if(text.match(/chet tili|ingliz/)) return "üî§";
      if(text.match(/boshlang/)) return "üéà";
      return "üìç"; 
    }

    let slides = [], currentSlide = 0;

    async function fetchSheet(range){
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.values || [];
    }

    /* ====== Slider core (fixed) ====== */
    const SLIDER_INTERVALS = new Map();

    function getImageArray(cell) {
      if (!cell) return [];
      if (Array.isArray(cell)) cell = cell.join(",");
      const found = Array.from(cell.matchAll(/https?:\/\/[^\s,;]+/g)).map(m => m[0].trim());
      if (found.length) return found;
      return cell.split(/[,;\n\s]+/).map(x => x.trim()).filter(x => x.startsWith("http"));
    }

    function createImageSlider(imagesRaw) {
      if (!imagesRaw || (Array.isArray(imagesRaw) && imagesRaw.length === 0)) return "";
      const images = getImageArray(imagesRaw);
      if (!images.length) return "";

      const id = "slider-" + Math.random().toString(36).substr(2, 9);

      const imgsHtml = images.map(
        (url, i) => `<img src="${url}" class="slider-img ${i === 0 ? "active" : ""}" data-index="${i}" alt="rasm">`
      ).join("");

      const dotsHtml = images.map(
        (_, i) => `<span class="dot ${i === 0 ? "active-dot" : ""}" data-index="${i}"></span>`
      ).join("");

      const html = `
        <div class="slider-container" id="${id}">
          <div class="slider-images">${imgsHtml}</div>
          <div class="slider-dots">${dotsHtml}</div>
        </div>
      `;

      return html;
    }

    function startSlider(container, count) {
      const el = (typeof container === "string") ? document.getElementById(container) : container;
      if (!el) return;
      const imgs = el.querySelectorAll(".slider-img");
      const dots = el.querySelectorAll(".dot");
      if (!imgs.length || count < 2) return;

      const id = el.id || null;
      if (id && SLIDER_INTERVALS.has(id)) {
        clearInterval(SLIDER_INTERVALS.get(id));
        SLIDER_INTERVALS.delete(id);
      }

      let cur = 0;
      imgs.forEach((img,i)=> img.classList.toggle("active", i===0));
      dots.forEach((d,i)=> d.classList.toggle("active-dot", i===0));

      const switchTo = (index) => {
        imgs[cur].classList.remove("active");
        dots[cur].classList.remove("active-dot");
        cur = index;
        imgs[cur].classList.add("active");
        dots[cur].classList.add("active-dot");
      };

      dots.forEach((dot, i) => {
        dot.onclick = () => {
          if (id && SLIDER_INTERVALS.has(id)) {
            clearInterval(SLIDER_INTERVALS.get(id));
            SLIDER_INTERVALS.delete(id);
          }
          switchTo(i);
          const newId = setInterval(()=> switchTo((cur+1)%count), 2000);
          if (id) SLIDER_INTERVALS.set(id, newId);
        };
      });

      const intervalId = setInterval(()=> switchTo((cur+1)%count), 2000);
      if (id) SLIDER_INTERVALS.set(id, intervalId);
    }

    function clearAllSliderIntervals() {
      SLIDER_INTERVALS.forEach(v => clearInterval(v));
      SLIDER_INTERVALS.clear();
    }

    function initSlidersInSlide() {
      const slideRoot = document.getElementById("slide-content");
      if (!slideRoot) return;
      const containers = slideRoot.querySelectorAll(".slider-container");
      containers.forEach(c => {
        const imgs = c.querySelectorAll(".slider-img");
        startSlider(c, imgs.length);
      });
    }

    /* ===== Rendering sections ===== */
    function renderNews(rows) {
      if (!rows.length) return "<p>Yangiliklar yo'q</p>";
      return rows.map(r=>{
        const images = getImageArray(r[3]);
        return `<div style="margin-bottom:36px;">
          <h3>${safeGet(r, 1)}</h3>
          <small style="opacity:0.7;">${safeGet(r, 0)}</small>
          <p style="margin:10px 0;">${safeGet(r, 2)}</p>
          ${createImageSlider(images)}
        </div>`;
      }).join("<hr>");
    }

    function renderStudents(rows) {
      if (!rows.length) return "<p>Ma'lumot yo'q</p>";
      return rows.map(r=>{
        const images = getImageArray(r[2]);
        return `<div style="margin-bottom:24px;">
          <b>${safeGet(r, 0)}</b> ‚Äî ${safeGet(r, 1)}
          ${createImageSlider(images)}
        </div>`;
      }).join("<hr>");
    }

    function renderClasses(rows) {
      if (!rows.length) return "<p>Ma'lumot yo'q</p>";
      return rows.map(r=>{
        const images = getImageArray(r[2]);
        return `<div style="margin-bottom:24px;">
          <b>${safeGet(r, 0)}</b> ‚Äî ${safeGet(r, 1)}
          ${createImageSlider(images)}
        </div>`;
      }).join("<hr>");
    }

    function renderQuarter(rows) {
      if (!rows.length) return "<p>Ma'lumot yo'q</p>";
      return rows.map(r=>{
        const images = getImageArray(r[3]);
        return `<div style="margin-bottom:24px;">
          <b>${safeGet(r, 0)}</b> ‚Äî ${safeGet(r, 1)} ball (${safeGet(r, 2)})
          ${createImageSlider(images)}
        </div>`;
      }).join("<hr>");
    }

    /* ===== –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø RENDERROOMS –î–õ–Ø –í–ê–®–ï–ô –°–¢–†–£–ö–¢–£–†–´ –î–ê–ù–ù–´–• ===== */
    function renderRooms(rows) {
      if (!rows.length) return '<p>Ma ºlumot yo ªq</p>';

      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —ç—Ç–∞–∂–∞–º
      const grouped = {};

      rows.forEach(r => {
        const floor = safeGet(r, 0) || '?';
        const room = safeGet(r, 1) || '';
        const className = safeGet(r, 2) || '';
        const teacher = safeGet(r, 3) || '';
        const description = safeGet(r, 4) || '';
        const highlightFlag = safeGet(r, 5) || ''; // –ö–æ–ª–æ–Ω–∫–∞ F - highlight

        if (!grouped[floor]) grouped[floor] = [];

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å (yes –≤ –∫–æ–ª–æ–Ω–∫–µ highlight)
        const isHighlight = highlightFlag.toLowerCase() === 'yes';

        // –í—ã–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–ø–∏—Å–∞–Ω–∏—è –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–ª–∞—Å—Å–∞
        const icon = chooseIcon(description + " " + className);

        grouped[floor].push({ 
          room, 
          className,
          teacher,
          description,
          isHighlight,
          icon
        });
      });

      return `<div style='display:flex;flex-wrap:wrap;gap:20px;justify-content:center;'>${
        Object.keys(grouped).sort().map(f => `
          <div class='floor-light'>
            <h3>${f}-qavat</h3>
            ${grouped[f].map(rr => `
              <div class='room-light ${rr.isHighlight ? "highlight" : ""}'>
                <div class='room-icon'>${rr.icon}</div>
                <div class='room-info'>
                  <span class='room-name'>Xona ${rr.room}</span>
                  ${rr.className ? `<div class='class-name'>${rr.className}</div>` : ''}
                  ${rr.teacher ? `<div class='teacher'>${rr.teacher}</div>` : ''}
                  ${rr.description ? `<div class='desc'>${rr.description}</div>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        `).join('')
      }</div>`;
    }

    /* ===== Load and build slides ===== */
    async function loadData(){
      const [news, students, classes, rooms, quarter] = await Promise.all([
        fetchSheet(SHEETS.news),
        fetchSheet(SHEETS.students),
        fetchSheet(SHEETS.classes),
        fetchSheet(SHEETS.rooms),
        fetchSheet(SHEETS.quarter)
      ]);

      slides = [
        { title: "üì∞ Yangiliklar", content: renderNews(news) },
        { title: "üèÖ Haftaning eng yaxshi o'quvchisi", content: renderStudents(students) },
        { title: "üè´ Haftaning eng yaxshi sinfi", content: renderClasses(classes) },
        { title: "üìä Chorak bo‚Äòyicha eng yaxshi ko‚Äòrsatkichli sinflar", content: renderQuarter(quarter) },
        { title: "üè¢ Xonalar va darslar", content: renderRooms(rooms) }
      ];

      renderMenu(rooms);
      renderMainDots();
      showSlide();
    }

    /* ===== Slide switching ===== */
    function fadeSlide(html){
      const el=document.getElementById("slide-content");
      el.classList.add("fade-out");
      clearAllSliderIntervals();
      setTimeout(()=>{
        el.innerHTML=html;
        el.classList.remove("fade-out");
        initSlidersInSlide();
      },420);
    }

    function showSlide(){
      if(!slides.length)return;
      const s=slides[currentSlide%slides.length];
      fadeSlide(`<h2>${s.title}</h2>${s.content}`);
      updateMainDots();
    }

    // auto-advance main slides every 8s
    setInterval(()=>{
      if(!slides.length) return;
      currentSlide = (currentSlide + 1) % slides.length;
      showSlide();
    },8000);

    /* ===== Main dots (sections) ===== */
    function renderMainDots(){
      const dots=document.getElementById("main-dots");
      dots.innerHTML=slides.map((_,i)=>`<div class="main-dot ${i===0?"active":""}" data-index="${i}"></div>`).join("");
      dots.querySelectorAll(".main-dot").forEach(dot=>{
        dot.addEventListener("click",()=>{
          currentSlide=parseInt(dot.dataset.index,10);
          showSlide();
        });
      });
    }

    function updateMainDots(){
      const all=document.querySelectorAll(".main-dot");
      all.forEach((d,i)=>d.classList.toggle("active", i === (currentSlide % slides.length)));
    }

    /* ===== Menu & Time ===== */
    function renderMenu(rows){
      document.getElementById("menu-panel").innerHTML=renderRooms(rows);
    }

    const btn=document.getElementById("menu-btn");
    const overlay=document.getElementById("menu-overlay");
    const panel=document.getElementById("menu-panel");
    btn.addEventListener("click",()=>{
      const open=panel.classList.toggle("open");
      overlay.classList.toggle("active",open);
      btn.textContent=open?"Menyu yopish":"Xonalar menyusi";
    });
    overlay.addEventListener("click",()=>{
      panel.classList.remove("open");
      overlay.classList.remove("active");
      btn.textContent="Xonalar menyusi";
    });

    function updateTime(){
      const n=new Date();
      const days=["Yakshanba","Dushanba","Seshanba","Chorshanba","Payshanba","Juma","Shanba"];
      document.getElementById("datetime").innerHTML=`
        <div>${n.toLocaleDateString()}</div>
        <div>${days[n.getDay()]}</div>
        <div>${n.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>`;
    }

    setInterval(updateTime,1000); updateTime();

    /* ===== Touch support for slide switching ===== */
    (function enableTouchNavigation(){
      let startX = 0;
      let distX = 0;
      const threshold = 60;

      document.addEventListener("touchstart", e => {
        const t = e.touches[0];
        startX = t.clientX;
      });

      document.addEventListener("touchmove", e => {
        const t = e.touches[0];
        distX = t.clientX - startX;
      });

      document.addEventListener("touchend", () => {
        if (Math.abs(distX) > threshold) {
          if (distX < 0) {
            currentSlide = (currentSlide + 1) % slides.length;
          } else {
            currentSlide = (currentSlide - 1 + slides.length) % slides.length;
          }
          showSlide();
        }
        distX = 0;
      });
    })();

    /* ===== Tap-to-next for photo sliders ===== */
    document.addEventListener("click", e => {
      const container = e.target.closest(".slider-container");
      if (!container) return;
      const imgs = container.querySelectorAll(".slider-img");
      if (imgs.length < 2) return;

      const curIndex = [...imgs].findIndex(i => i.classList.contains("active"));
      const next = (curIndex + 1) % imgs.length;

      imgs[curIndex].classList.remove("active");
      imgs[next].classList.add("active");

      const dots = container.querySelectorAll(".dot");
      if (dots.length) {
        dots[curIndex].classList.remove("active-dot");
        dots[next].classList.add("active-dot");
      }
    });

    /* ===== Start ===== */
    loadData();
    setInterval(loadData,60000);

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maktab Axborot Paneli</title>
  <style>
    :root{
      --bg:#081121;
      --accent:#00c4ff;
      --card-bg:rgba(255,255,255,0.08);
      --text:#f0f8ff;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--text);overflow:hidden}
    .screen{width:100%;height:100%;display:flex;align-items:center;justify-content:center;position:relative}
    .header{position:absolute;top:18px;left:0;width:100%;text-align:center;color:var(--accent);font-size:36px;font-weight:700;text-shadow:0 0 15px rgba(0,196,255,0.6);display:flex;flex-direction:column;align-items:center;justify-content:center;line-height:1.3}
    .date-line{font-size:22px;color:#a9e6ff;font-weight:500;text-shadow:0 0 10px rgba(0,196,255,0.3)}
    #clock{position:absolute;top:24px;right:40px;font-size:34px;font-weight:600;color:var(--accent);letter-spacing:1px;text-shadow:0 0 12px rgba(0,196,255,0.4)}
    .slides{position:absolute;inset:0;display:flex;justify-content:center;align-items:center}
    .slide{position:absolute;width:100%;height:100%;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .9s ease-in-out}
    .slide.active{opacity:1;z-index:2}
    .slide-inner{background:var(--card-bg);padding:36px;border-radius:20px;backdrop-filter:blur(8px);width:80%;max-width:980px;text-align:center}
    h1{font-size:44px;margin-bottom:18px;color:var(--accent)}
    .card{background:rgba(255,255,255,0.04);padding:18px 24px;border-radius:12px;margin:10px 0;font-size:22px}
    @keyframes zoomIn{from{transform:scale(.95);opacity:0}to{transform:scale(1);opacity:1}}
    .footer{position:absolute;bottom:36px;width:100%;text-align:center}
    .hint{display:inline-block;padding:14px 36px;background:linear-gradient(90deg,rgba(0,196,255,0.2),rgba(180,58,255,0.2));border-radius:999px;font-weight:600;color:var(--accent);cursor:pointer;font-size:22px;backdrop-filter:blur(6px);box-shadow:0 0 18px rgba(0,196,255,0.18);user-select:none;touch-action:manipulation}
    .overlay{position:absolute;inset:0;background:rgba(0,0,0,0.88);backdrop-filter:blur(8px);transform:translateY(100%);transition:transform .35s ease;padding:26px;overflow-y:auto;font-size:18px}
    .overlay.open{transform:translateY(0)}
    .menu-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .menu-title{font-size:28px;font-weight:700;color:var(--accent);text-shadow:0 0 8px rgba(0,196,255,0.4)}
    .menu-close{background:var(--accent);border:none;border-radius:10px;padding:8px 12px;color:#fff;cursor:pointer;font-size:16px}
    .floors{display:block}
    .floor{margin-bottom:16px}
    .floor h2{color:var(--accent);margin-bottom:10px;font-size:20px}
    .rooms{display:flex;flex-wrap:wrap;gap:12px}
    .room{background:var(--card-bg);padding:12px;border-radius:10px;min-width:240px;display:flex;gap:12px;align-items:center;cursor:pointer;transition:.12s}
    .room:hover{transform:translateY(-4px);box-shadow:0 10px 26px rgba(0,0,0,0.4)}
    .room img{width:86px;height:86px;border-radius:6px;object-fit:cover;border:2px solid var(--accent)}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7)}
    .modal.show{display:flex}
    .modal-content{background:#0f1824;padding:18px;border-radius:10px;text-align:center;width:420px;max-width:94%}
    .modal-content img{width:160px;height:160px;border-radius:8px;object-fit:cover;border:3px solid var(--accent);margin-bottom:10px}
    .modal-close{margin-top:10px;padding:8px 12px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer}
    .muted{color:#9fb0c0;font-size:16px}
  </style>
</head>
<body>
  <div class="screen">
    <div class="header">
      üè´ ‚Ññ15 Umumta'lim maktabi
      <div class="date-line" id="date-line">üìÖ Yuklanmoqda...</div>
    </div>

    <div id="clock"></div>

    <div class="slides" id="slides"></div>

    <div class="footer">
      <div id="hint" class="hint">üè† Bosh sahifa</div>
    </div>

    <div id="overlay" class="overlay" aria-hidden="true">
      <div class="menu-top">
        <div id="menu-title" class="menu-title">Sinflar va xonalar jadvali</div>
        <button id="close" class="menu-close">Yopish</button>
      </div>
      <div id="floors" class="floors"></div>
    </div>

    <div id="modal" class="modal">
      <div id="modal-content" class="modal-content"></div>
    </div>
  </div>

  <script>
    // ====== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Google Sheets ======
    const SHEET_ID = "1Z1wyUYj4l-D_egywsnPEiLU7CbXs7OFVN5qbAQ9ttzA";
    const API_KEY  = "AIzaSyApl7_bMpqpB9GXrxUtVAfaTfNtrhyEcgM";
    const RANGE_MAIN = "–õ–∏—Å—Ç1!A1:M100";
    const RANGE_SCHEDULE = "schedule!A1:H100";

    // ====== –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç ======
    const oylar = ["yanvar","fevral","mart","aprel","may","iyun","iyul","avgust","sentyabr","oktyabr","noyabr","dekabr"];
    const kunlar = ["yakshanba","dushanba","seshanba","chorshanba","payshanba","juma","shanba"];

    function updateDate() {
      const now = new Date();
      const day = now.getDate();
      const month = oylar[now.getMonth()];
      const year = now.getFullYear();
      const weekday = kunlar[now.getDay()];
      const el = document.getElementById('date-line');
      if (el) el.textContent = `üìÖ ${day}-${month} ${year}-yil, ${weekday}`;
    }

    // ====== –ù–∞–¥–µ–∂–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ª–∏—Å—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ—à–∏–±–æ–∫ ======
    async function loadSheet(range) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
      try {
        const res = await fetch(url);
        if (!res.ok) {
          console.error("Google Sheets API error:", res.status, res.statusText);
          return []; // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        }
        const j = await res.json();
        if (!j.values || j.values.length === 0) {
          console.warn("–ü—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω:", range);
          return [];
        }
        const [headers, ...rows] = j.values;
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ ‚Äî –µ—Å–ª–∏ –∫–∞–∫–∏–µ-—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è –ø—É—Å—Ç—ã, —Å—Ç–∞–≤–∏–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
        return rows.map(row => Object.fromEntries(headers.map((h, i) => [h, row[i] !== undefined ? row[i] : ""])));
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ fetch Google Sheets:", err);
        return [];
      }
    }

    // ====== –ü–∞—Ä—Å–µ—Ä —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É DATA ======
    function parseData(rows) {
      return {
        best_student_week: rows.find(r => r.type === "best_student_week") || {},
        best_class_week: rows.find(r => r.type === "best_class_week") || {},
        recent_events: rows.filter(r => r.type === "recent_event"),
        top_classes_quarter: rows.filter(r => r.type === "top_class_quarter"),
        schedule: rows.filter(r => r.type === "schedule"),
        floors: Object.values(rows.filter(r => r.type === "room_info").reduce((acc, r) => {
          const f = r.floor || '0';
          if (!acc[f]) acc[f] = { floor: f, rooms: [] };
          acc[f].rooms.push(r);
          return acc;
        }, {}))
      };
    }

    // ====== –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è UI ======
    function makeSlide(title, contentHtml) {
      const s = document.createElement('div');
      s.className = 'slide';
      s.innerHTML = `<div class="slide-inner"><h1>${title}</h1>${contentHtml}</div>`;
      return s;
    }

    function renderSlides(d) {
      const slides = document.getElementById('slides');
      slides.innerHTML = '';

      // So'nggi voqealar
      slides.appendChild(makeSlide('üì∞ So‚Äònggi voqealar',
        d.recent_events.length
          ? d.recent_events.map(e => `<div class="card"><b>${e.title || ""}</b><div class="muted">${e.date || ""}</div></div>`).join('')
          : '<div class="card">Hech qanday voqea yo‚Äòq</div>'
      ));

      // Best student
      slides.appendChild(makeSlide("üéì Haftaning eng yaxshi o'quvchisi", `
        <div class="card" style="display:flex;flex-direction:column;align-items:center;">
          <img src="${(d.best_student_week && d.best_student_week.student_img && d.best_student_week.student_img.startsWith('http')) ? d.best_student_week.student_img : 'https://via.placeholder.com/240x240?text=No+Image'}"
            style="width:240px;height:240px;object-fit:cover;border-radius:12px;margin-bottom:18px;border:4px solid var(--accent);animation:zoomIn .9s ease;" alt="O'quvchi rasmi">
          <b style="font-size:1.6em;">${d.best_student_week?.name || "‚Äî"}</b>
          <div style="font-size:1.2em;color:#9fdfff">${d.best_student_week?.class || ""}</div>
          <div style="margin-top:10px;font-size:1.1em;">Bahosi: ${d.best_student_week?.score || "-"}</div>
        </div>
      `));

      // Best class
      slides.appendChild(makeSlide("üè´ Haftaning eng yaxshi sinfi",
        `<div class="card"><b>${d.best_class_week?.class || "-"}</b><br>O'rtacha baho: ${d.best_class_week?.avg || "-"}</div>`
      ));

      // Top classes quarter
      slides.appendChild(makeSlide("üèÜ Chorakdagi eng yaxshi sinflar",
        d.top_classes_quarter.length
          ? d.top_classes_quarter.map(c => `<div class="card"><b>${c.class || ""}</b> ‚Äî ${c.avg || ""}</div>`).join('')
          : "<div class='card'>Ma'lumot yo'q</div>"
      ));
    }

    function renderFloors(d) {
      const cont = document.getElementById('floors');
      cont.innerHTML = '';
      d.floors.sort((a,b) => Number(b.floor) - Number(a.floor));
      d.floors.forEach(f => {
        const div = document.createElement('div');
        div.className = 'floor';
        div.innerHTML = `<h2>${f.floor}-qavat</h2>`;
        const rooms = document.createElement('div');
        rooms.className = 'rooms';
        f.rooms.forEach(r => {
          const scheduleInfo = d.schedule.find(s => String(s.room) === String(r.room));
          const subject = scheduleInfo?.subject || r.subject || '‚Äî';
          const teacher = scheduleInfo?.teacher || r.teacher || '';
          const imgSrc = r.teacher_img && r.teacher_img.startsWith('http') ? r.teacher_img : 'https://via.placeholder.com/160?text=No+Img';
          const el = document.createElement('div');
          el.className = 'room';
          el.innerHTML = `
            <img src="${imgSrc}" alt="teacher">
            <div>
              <div style="font-weight:700">${r.room || ''} ‚Äî ${r.class || ''}</div>
              <div style="color:#9fb0c0">${subject}</div>
              <div style="font-size:14px;color:#9fb0c0">${teacher}</div>
            </div>`;
          el.addEventListener('click', () => showModal({ room: r.room, class: r.class, subject, teacher, teacher_img: r.teacher_img }));
          rooms.appendChild(el);
        });
        div.appendChild(rooms);
        cont.appendChild(div);
      });
    }

    function showModal(info) {
      const m = document.getElementById('modal');
      const c = document.getElementById('modal-content');
      const imgSrc = info.teacher_img && info.teacher_img.startsWith('http') ? info.teacher_img : 'https://via.placeholder.com/160?text=No+Img';
      c.innerHTML = `
        <img src="${imgSrc}" alt="img">
        <h3>${info.room || ''} ‚Äî ${info.class || ''}</h3>
        <p style="color:var(--accent);font-size:16px;margin:6px 0">${info.subject || '‚Äî'}</p>
        <p>O'qituvchi: <b>${info.teacher || '‚Äî'}</b></p>
        <button class="modal-close" onclick="document.getElementById('modal').classList.remove('show')">Yopish</button>
      `;
      m.classList.add('show');
    }

    // ====== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é –∏ —Å–ª–∞–π–¥–∞–º–∏ ======
    function restartSlides() {
      const s = document.querySelectorAll('.slide');
      if (!s.length) return;
      // —É–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
      if (window.slideInterval) { clearInterval(window.slideInterval); window.slideInterval = null; }
      // —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π
      s.forEach(el => el.classList.remove('active'));
      s[0].classList.add('active');
      let idx = 0;
      window.slideInterval = setInterval(() => {
        s[idx].classList.remove('active');
        idx = (idx + 1) % s.length;
        s[idx].classList.add('active');
      }, 5000); // 5 —Å–µ–∫—É–Ω–¥
    }

    // ====== Clock & date ======
    function updateClock() {
      const n = new Date();
      const h = n.getHours().toString().padStart(2,'0');
      const m = n.getMinutes().toString().padStart(2,'0');
      const el = document.getElementById('clock');
      if (el) el.textContent = `${h}:${m}`;
    }

    // ====== Main: DOMContentLoaded ======
    window.addEventListener('DOMContentLoaded', async () => {
      // UI elements
      const overlay = document.getElementById('overlay');
      const hint    = document.getElementById('hint');
      const closeBtn= document.getElementById('close');
      const dateLine= document.getElementById('date-line');

      // attach menu handlers safely
      if (hint) {
        hint.addEventListener('click', () => {
          overlay.classList.add('open');
          overlay.setAttribute('aria-hidden','false');
          if (window.slideInterval) { clearInterval(window.slideInterval); window.slideInterval = null; }
        }, {passive:true});
      }
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          overlay.classList.remove('open');
          overlay.setAttribute('aria-hidden','true');
          restartSlides();
        }, {passive:true});
      }
      overlay.addEventListener('click', e => {
        if (e.target === overlay) {
          overlay.classList.remove('open');
          overlay.setAttribute('aria-hidden','true');
          restartSlides();
        }
      });
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          overlay.classList.remove('open');
          overlay.setAttribute('aria-hidden','true');
          restartSlides();
        }
      });

      // start clock/date
      updateDate();
      updateClock();
      setInterval(updateDate, 60000);
      setInterval(updateClock, 1000);

      // load sheets
      dateLine.textContent = 'üìÖ Ma\'lumot yuklanmoqda...';
      const mainRows = await loadSheet(RANGE_MAIN);
      const scheduleRows = await loadSheet(RANGE_SCHEDULE);

      // If both empty -> show warning
      if ((!mainRows || mainRows.length === 0) && (!scheduleRows || scheduleRows.length === 0)) {
        dateLine.textContent = '‚ö†Ô∏è Ma\'lumot topilmadi (Google Sheets)';
        console.warn('Both sheets returned no data. Check sheet access, sheet names and API key.');
        // still try to render empty UI so button works
        renderSlides({ recent_events: [], top_classes_quarter: [], best_student_week: {}, best_class_week: {}, schedule: [], floors: [] });
        return;
      }

      // combine rows and parse
      const allRows = [...mainRows, ...scheduleRows];
      const DATA = parseData(allRows);

      // render UI
      renderSlides(DATA);
      renderFloors(DATA);

      // start slides
      restartSlides();

      // update status line
      dateLine.textContent = '‚úÖ Ma\'lumot yuklandi';
      console.log('Sheets loaded rows:', mainRows.length, scheduleRows.length);
    });
  </script>
</body>
</html>
